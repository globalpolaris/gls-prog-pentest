# Zia Kasyfi Nugroho
# 2301881581
# LB07

"""
This script needs exiftool installed on your system.
"""

import subprocess
from getopt import getopt
import sys

STEGANO = False
GET = False
DATA = ""
IMAGE = ""


def help():
    print("Usage: python3 stegano.py [options]")
    print("Options:")
    print("-s, --steg: Encode a message into a file")
    print("-g, --get: Decode a message from a file")
    print("-h, --help: Show this help message")
    print("Example: python3 stegano.py -s image.png -d sudo -l")
    print("Example: python3 stegano.py -g image.png")


def write_file():
    cmd = input("Enter command to execute: ")
    arg = f"exiftool -Comment='{cmd}' {IMAGE}"
    process = subprocess.Popen(
        args=arg, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE, shell=True)
    stdout, stderr = process.communicate()
    if stderr != b'':
        print(stderr)
    else:
        print("Command executed successfully")


def get_file():
    print(IMAGE)
    process = subprocess.Popen(
        args=f"exiftool -Comment {IMAGE}", stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE, shell=True)
    stdout, stderr = process.communicate()
    if stderr != b'':
        print(stderr)
    else:
        cmd = stdout.decode('utf-8')
        cmd = cmd.split(":")[1].rstrip()
        process = subprocess.Popen(
            args=cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE, shell=True)
        stdout, stderr = process.communicate()
        if stderr != b'':
            print(stderr)
        else:
            print(stdout.decode('utf-8'))


def main():
    global STEGANO, GET,  IMAGE
    opts, _ = getopt(sys.argv[1:], "s:g:h", [
                     "steg=", "get=", "help"])
    for key, value in opts:
        if key in ("-s", "--steg"):
            STEGANO = True
            IMAGE = value
        elif key in ("-g", "--get"):
            GET = True
            IMAGE = value
        elif key in ("-h", "--help"):
            help()
            sys.exit()
    if STEGANO:
        write_file()
    elif GET:
        get_file()


if __name__ == '__main__':
    main()
